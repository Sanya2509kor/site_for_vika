{% extends "base.html" %}
{% load static %}

{% block title %}
    <title> {{ title }} </title>
{% endblock title %}

{% block content %}
<section id="services" class="py-5">
    <div class="container">
        <div class="text-center mb-5">
            {% comment %} <h2 class="fw-bold"> {{ title_text }} </h2>
            <p class="text-muted"> {{ text }} </p> {% endcomment %}
        </div>
        
        <div class="row row-cols-1 row-cols-md-3 g-4 justify-content-center">
            {% for object in objects %}
                {% comment %} {% if object.image %} {% endcomment %}
                        <div class="col">
                            <div class="service-card">
                                <div class="carousel">
                                    <div class="images">
                                        {% for image in object.images.all %}
                                            <img src="{{ image.image.url }}" alt="{{ object.name }}">
                                        {% endfor %}
                                    </div>
                                    <!-- Добавлен отдельный счетчик для мобильных -->
                                    <div class="mobile-counter">1 / {{ object.images.count }}</div>
                                    <div class="controls">
                                        <button class="prev">⬅</button>
                                        <span class="current-image">1 / {{ object.images.count }}</span>
                                        <button class="next">➡</button>
                                    </div>
                                </div>
                                <div class="card-body text-center">
                                    <h5 class="card-title"> {{ object.name }} </h5>
                                    <p class="card-text"> {{ object.description }} </p>
                                </div>
                            </div>
                        </div>
                {% comment %} {% endif %} {% endcomment %}
            {% endfor %}
        </div>
    {% include "pagination.html" %}
    </div>
</section>

<style>

.service-card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    transition: transform 0.3s;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    background-color: #cce6cf;
}

.service-card .carousel {
    position: relative;
    overflow: hidden;
    max-width: 100%;
    height: 250px;
    touch-action: pan-y;
}

.service-card .images {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    transition: transform 0.1s ease; /* Плавное перемещение */
    will-change: transform; /* Оптимизация анимации */
    
}

.service-card .images img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    flex-shrink: 0;
}

/* Стили для счетчика на мобильных */
.service-card .mobile-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 14px;
    z-index: 10;
    display: none; /* По умолчанию скрыт */
}

.service-card .controls {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 10;
    background: rgba(255, 255, 255, 0.7);
    padding: 5px 10px;
    border-radius: 20px;
}

.service-card .controls button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: #333;
}

.service-card .current-image {
    font-size: 14px;
    color: #555;
}



/* Адаптивные стили */
@media (max-width: 768px) {
    .service-card .controls {
        display: none; /* Скрываем кнопки на мобильных */
    }
    
    .service-card .mobile-counter {
        display: block; /* Показываем мобильный счетчик */
    }
    
    .service-card .current-image {
        display: none; /* Скрываем десктопный счетчик */
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousels = document.querySelectorAll('.carousel');
    
    carousels.forEach(carousel => {
        const imagesContainer = carousel.querySelector('.images');
        const images = carousel.querySelectorAll('.images img');
        let currentIndex = 0;
        let startX = 0;
        let isDragging = false;
        let animationFrameId = null;
        let startTime = null;
        const animationDuration = 200; // 0.5 секунды
        
        // Элементы счетчиков
        const desktopCounter = carousel.querySelector('.current-image');
        const mobileCounter = carousel.querySelector('.mobile-counter');
        
        function animateTransition(targetIndex) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            const startIndex = currentIndex;
            const startOffset = -startIndex * 100;
            const targetOffset = -targetIndex * 100;
            startTime = performance.now();
            
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / animationDuration, 1);
                
                // Плавное замедление в конце (ease-out)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentOffset = startOffset + (targetOffset - startOffset) * easeProgress;
                
                imagesContainer.style.transform = `translateX(${currentOffset}%)`;
                
                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(step);
                } else {
                    animationFrameId = null;
                    currentIndex = targetIndex;
                    updateCounter();
                }
            }
            
            animationFrameId = requestAnimationFrame(step);
        }
        
        function updateCounter() {
            const counterText = (currentIndex + 1) + ' / ' + images.length;
            if (desktopCounter) desktopCounter.textContent = counterText;
            if (mobileCounter) mobileCounter.textContent = counterText;
        }
        
        // Обработчики для кнопок
        const prevButton = carousel.querySelector('.prev');
        const nextButton = carousel.querySelector('.next');
        
        prevButton?.addEventListener('click', function() {
            if (animationFrameId) return; // Не прерываем текущую анимацию
            const newIndex = (currentIndex - 1 + images.length) % images.length;
            animateTransition(newIndex);
        });
        
        nextButton?.addEventListener('click', function() {
            if (animationFrameId) return;
            const newIndex = (currentIndex + 1) % images.length;
            animateTransition(newIndex);
        });
        
        // Обработчики для свайпов
        carousel.addEventListener('touchstart', handleTouchStart, {passive: true});
        carousel.addEventListener('touchmove', handleTouchMove, {passive: false});
        carousel.addEventListener('touchend', handleTouchEnd);
        
        function handleTouchStart(e) {
            if (animationFrameId) return;
            startX = e.touches[0].clientX;
            isDragging = true;
            imagesContainer.style.transition = 'none'; // Отключаем анимацию при драге
        }
        
        function handleTouchMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const x = e.touches[0].clientX;
            const diff = x - startX;
            
            const offset = -currentIndex * 100 + (diff / carousel.offsetWidth) * 100;
            imagesContainer.style.transform = `translateX(${offset}%)`;
        }
        
        function handleTouchEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            
            imagesContainer.style.transition = 'transform 0.5s ease'; // Включаем анимацию обратно
            
            const endX = e.changedTouches[0].clientX;
            const diff = endX - startX;
            const threshold = carousel.offsetWidth * 0.2;
            
            let newIndex = currentIndex;
            if (diff > threshold && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (diff < -threshold && currentIndex < images.length - 1) {
                newIndex = currentIndex + 1;
            }
            
            animateTransition(newIndex);
        }
        
        // Инициализация
        updateCounter();
    });
});
</script>

{% endblock content %}