{% extends "base.html" %}
{% load static %}

{% block title %}
<title> {{ title }} </title>
{% endblock title %}

{% block content %}
    <div class="gallery-container">
        <div class="main-image-container"id="swipeContainer">
            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
        </div>
        
        <div class="thumbnails" id="thumbnailsContainer">
            <!-- Основное изображение как первый элемент -->
            <img src="{{ product.image.url }}" class="thumbnail {% if all_images|length == 1 %}active{% endif %} but-prod" 
                 onclick="changeImage(0)" alt="{{ product.name }}">
            
            <!-- Дополнительные изображения -->
            {% for image in product.images.all %}
                <img src="{{ image.image.url }}" class="thumbnail but-prod" 
                     onclick="changeImage({{ forloop.counter }})" alt="{{ image.description|default:product.name }}">
            {% endfor %}
        </div>
        {% if product.available_colors.all %}
        <div class="color-selector">
            <h5>Доступные цвета (можно выбрать несколько):</h5>
            <form method="post" id="colorForm">
                {% csrf_token %}
                <div class="color-options">
                    {% for color in product.available_colors.all %}
                    <label class="color-option">
                        <input type="checkbox" name="colors" value="{{ color.id }}" class="color-checkbox">
                        {% if color.image %}
                            <img src="{{ color.image.url }}" alt="{{ color.name }}" width="100" height="100" class="color-image">
                        {% else %}
                            <span class="color-name">{{ color.name }}</span>
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>
                <input type="hidden" name="product_id" value="{{ product.id }}">
            </form>
        </div>
        {% endif %}
    </div>

<section id="services" class="py-5">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="fw-bold"> {{ product.name }} </h1>
            <p class="text-muted"> {{ product.description }} </p>
            <p> <span class="price-badge">от {{ product.price }} ₽</span></p>
            <a href="{% url "order:appointment" %}?product_id={{ product.id }}" class="text-decoration-none">
                <a href="#" id="appointmentLink" class="price-badge price-badge-two">Записаться</a>
            </a>
        </div>
    </div>
</section>

 <style>
        /* Стили для выбора цветов */
        .color-selector {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .color-option {
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .color-checkbox {
            display: none;
        }
        
        .color-checkbox:checked + .color-image {
            border: 10px solid #bd1818ff;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        
        .color-checkbox:checked + .color-name {
            background: #000;
            color: white;
        }
        
        .color-image {
            border-radius: 50%;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .color-name {
            display: inline-block;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-add-to-cart {
            background: #000;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-add-to-cart:hover {
            background: #333;
        }
</style>

<script>
    // Обработчик формы (можно добавить AJAX)
        document.getElementById('colorForm').addEventListener('submit', function(e) {
            const selectedColors = document.querySelectorAll('.color-checkbox:checked');
            if (selectedColors.length === 0) {
                e.preventDefault();
                alert('Пожалуйста, выберите хотя бы один цвет');
            }
            // Можно добавить здесь AJAX-отправку формы
        });

        // Ваш существующий JavaScript для галереи остается без изменений
        // Собираем все URL изображений в массив
        const images = [
            "{{ product.image.url }}",  // Основное изображение
            {% for image in product.images.all %}
                "{{ image.image.url }}",
            {% endfor %}
        ];
        
        let currentIndex = 0;
        const mainImage = document.getElementById('mainImage');
        const thumbnails = document.querySelectorAll('.thumbnail');
        
        function updateGallery() {
            mainImage.src = images[currentIndex];
            
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentIndex);
            });
        }
        
        function changeImage(index) {
            currentIndex = index;
            updateGallery();
        }
        
        function nextImage() {
            currentIndex = (currentIndex + 1) % images.length;
            updateGallery();
        }
        
        function prevImage() {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            updateGallery();
        }
        
        // Добавляем обработчик клавиатуры
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'ArrowLeft') prevImage();
        });

        let touchStartX = 0;
        let touchEndX = 0;
    
        swipeContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});
    
        swipeContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});
    
        function handleSwipe() {
            const swipeThreshold = 50; // Минимальная дистанция свайпа
        
            if (touchStartX - touchEndX > swipeThreshold) {
            // Свайп влево = следующее изображение
                nextImage();
            } else if (touchEndX - touchStartX > swipeThreshold) {
                // Свайп вправо = предыдущее изображение
                prevImage();
            }
        }

        function updateGallery() {
        mainImage.classList.add('flip');
    
        setTimeout(() => {
            mainImage.src = images[currentIndex];
            mainImage.classList.remove('flip');
        
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentIndex);
            });
        }, 500); // Половина от времени анимации (0.7s)
        }
        
        // Инициализация галереи
        updateGallery();
</script>
<script>
document.getElementById('appointmentLink').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Получаем выбранные цвета
    const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked'))
                              .map(checkbox => checkbox.value);
    
    
    // Формируем URL с GET-параметрами
    const baseUrl = "{% url 'order:appointment' %}";
    const params = new URLSearchParams();
    params.append('product_id', '{{ product.id }}');
    selectedColors.forEach(color => params.append('colors', color));
    
    // Перенаправляем с параметрами
    window.location.href = `${baseUrl}?${params.toString()}`;
});
</script>
{% endblock content %}

