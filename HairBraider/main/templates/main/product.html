{% extends "base.html" %}
{% load static %}

{% block title %}
<title> {{ title }} </title>
{% endblock title %}

{% block content %}
    <div class="gallery-container">
        <div class="main-image-container"id="swipeContainer">
            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
        </div>
        
        <div class="thumbnails" id="thumbnailsContainer">
            <!-- Основное изображение как первый элемент -->
            <img src="{{ product.image.url }}" class="thumbnail {% if all_images|length == 1 %}active{% endif %} but-prod" 
                 onclick="changeImage(0)" alt="{{ product.name }}">
            
            <!-- Дополнительные изображения -->
            {% for image in product.images.all %}
                <img src="{{ image.image.url }}" class="thumbnail but-prod" 
                     onclick="changeImage({{ forloop.counter }})" alt="{{ image.description|default:product.name }}">
            {% endfor %}
        </div>
    </div>

<section id="services" class="py-5">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="fw-bold"> {{ product.name }} </h1>
            <p class="text-muted"> {{ product.description }} </p>
            <p> <span class="price-badge">от {{ product.price }} ₽</span></p>
            <a href="{% url "order:appointment" %}?product_id={{ product.id }}" class="text-decoration-none">
                <span class="price-badge price-badge-two">Записаться</span>
            </a>
        </div>
    </div>
</section>


<script>
        // Собираем все URL изображений в массив
        const images = [
            "{{ product.image.url }}",  // Основное изображение
            {% for image in product.images.all %}
                "{{ image.image.url }}",
            {% endfor %}
        ];
        
        let currentIndex = 0;
        const mainImage = document.getElementById('mainImage');
        const thumbnails = document.querySelectorAll('.thumbnail');
        
        function updateGallery() {
            mainImage.src = images[currentIndex];
            
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentIndex);
            });
        }
        
        function changeImage(index) {
            currentIndex = index;
            updateGallery();
        }
        
        function nextImage() {
            currentIndex = (currentIndex + 1) % images.length;
            updateGallery();
        }
        
        function prevImage() {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            updateGallery();
        }
        
        // Добавляем обработчик клавиатуры
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'ArrowLeft') prevImage();
        });

        let touchStartX = 0;
        let touchEndX = 0;
    
        swipeContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});
    
        swipeContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});
    
        function handleSwipe() {
            const swipeThreshold = 50; // Минимальная дистанция свайпа
        
            if (touchStartX - touchEndX > swipeThreshold) {
            // Свайп влево = следующее изображение
                nextImage();
            } else if (touchEndX - touchStartX > swipeThreshold) {
                // Свайп вправо = предыдущее изображение
                prevImage();
            }
        }

        function updateGallery() {
        mainImage.classList.add('flip');
    
        setTimeout(() => {
            mainImage.src = images[currentIndex];
            mainImage.classList.remove('flip');
        
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentIndex);
            });
        }, 500); // Половина от времени анимации (0.7s)
        }
        
        // Инициализация галереи
        updateGallery();
</script>
{% endblock content %}

