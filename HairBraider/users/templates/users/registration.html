{% extends "base.html" %}
{% load static %}

{% block title %}
<title> {{ title }} </title>
{% endblock title %}

{% block content %}
{% comment %} <div class="row"> {% endcomment %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-9 p-4 mb-5 mx-2 rounded custom-shadow registration-form">
                <h2 class="text-center mb-4">Регистрация</h2>
                <form action="{% url 'user:registration' %}" method="post" id="registration_form">
                    {% csrf_token %}
                    
                    <!-- Общие ошибки формы -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <!-- Имя -->
                        <div class="col-md-6 mb-3">
                            <label for="id_first_name" class="form-label">Имя*</label>
                            <input type="text" class="form-control" id="id_first_name"
                                name="first_name"
                                value="{{ form.first_name.value|default_if_none:'' }}"
                                placeholder="Введите ваше имя" required>
                            {% if form.first_name.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <!-- Номер телефона -->
                        <div class="col-md-6 mb-3">
                            <label for="id_phone_number" class="form-label">Номер телефона*:</label>
                            <input type="text" class="form-control" id="id_phone_number" 
                                name="phone_number"
                                value="{{ form.phone_number.value|default_if_none:'' }}"
                                placeholder="(000)000-0000" required>
                            {% if form.phone_number.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.phone_number.errors }}</div>
                            {% endif %}
                            <div class="alert alert-danger alert-dismissible fade show" style="display: none" id="phone_number_error">
                                Неверный формат номера. Используйте формат: +7(929)999-9999
                            </div>
                        </div>
                        <!-- Пароль -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password1" class="form-label">Пароль*</label>
                            <input type="password" class="form-control" id="id_password1"
                                name="password1"
                                placeholder="Введите пароль" required>
                            {% if form.password1.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.password1.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Подтверждение пароля -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password2" class="form-label">Подтверждение пароля*</label>
                            <input type="password" class="form-control" id="id_password2"
                                name="password2"
                                placeholder="Подтвердите пароль" required>
                            {% if form.password2.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.password2.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-dark btn-block">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>
{% comment %} </div> {% endcomment %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
    // Форматирование ввода номера телефона в реальном времени
    $('#id_phone_number').on('input', function(e) {
        // Удаляем все нецифровые символы, кроме возможного плюса в начале
        var value = e.target.value.replace(/[^\d+]/g, '');
        
        // Если номер начинается не с +7 или 7 или 8, добавляем +7
        if (!value.startsWith('+7') && !value.startsWith('7') && !value.startsWith('8')) {
            value = '+7' + value;
        }
        
        // Форматируем номер: +7 999 198-72-64
        var formatted = value
            .replace(/^(\+?7|8)(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/, function(match, p1, p2, p3, p4, p5) {
                let result = '+7';
                if (p2) result += ' ' + p2;
                if (p3) result += ' ' + p3;
                if (p4) result += '-' + p4;
                if (p5) result += '-' + p5;
                return result;
            });
        
        e.target.value = formatted;
    });

    // Валидация формы перед отправкой
    $('#registration_form').on('submit', function(event) {
        // Проверка номера телефона
        var phoneNumber = $('#id_phone_number').val();
        
        // Регулярное выражение для российского номера:
        // +7 или 7 или 8, затем 10 цифр
        var regex = /^(\+7|7|8)\d{10}$/;
        
        // Очищаем номер для проверки (удаляем все, кроме цифр и +)
        var cleanedPhoneNumber = phoneNumber.replace(/[^\d+]/g, '');
        
        // Если номер начинается с 8, заменяем на +7
        if (cleanedPhoneNumber.startsWith('8')) {
            cleanedPhoneNumber = '+7' + cleanedPhoneNumber.substring(1);
        }
        // Если номер начинается с 7 (без +), добавляем +
        else if (cleanedPhoneNumber.startsWith('7') && !cleanedPhoneNumber.startsWith('+7')) {
            cleanedPhoneNumber = '+' + cleanedPhoneNumber;
        }
        
        if (!regex.test(cleanedPhoneNumber)) {
            $('#phone_number_error').text('Введите корректный номер телефона (например: +7 999 123-45-67)').show();
            event.preventDefault();
            return false;
        } else {
            $('#phone_number_error').hide();
            
            // Сохраняем очищенный номер в формате +79991234567
            $('#id_phone_number').val(cleanedPhoneNumber);
        }
        
        return true;
    });
});
</script>
{% endblock %}