{% extends "base.html" %}
{% load static %}

{% comment %} {% block modal_cart %}
{% include "includes/cart_button.html" %}
{% endblock %} {% endcomment %}

{% block content %}
<div class="row">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-9 bg-white p-4 mb-5 mx-2 rounded custom-shadow">
                <h2 class="text-center mb-4">Регистрация</h2>
                <form action="{% url 'user:registration' %}" method="post" id="registration_form">
                    {% csrf_token %}
                    
                    <!-- Общие ошибки формы -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <!-- Имя -->
                        <div class="col-md-6 mb-3">
                            <label for="id_first_name" class="form-label">Имя*</label>
                            <input type="text" class="form-control" id="id_first_name"
                                name="first_name"
                                value="{{ form.first_name.value|default_if_none:'' }}"
                                placeholder="Введите ваше имя" required>
                            {% if form.first_name.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Имя пользователя (username) -->
                        <div class="col-md-6 mb-3">
                            <label for="id_username" class="form-label">Имя пользователя*</label>
                            <input type="text" class="form-control" id="id_username"
                                name="username"
                                value="{{ form.username.value|default_if_none:'' }}"
                                placeholder="Введите имя пользователя" required>
                            {% if form.username.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.username.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Номер телефона -->
                        <div class="col-md-6 mb-3">
                            <label for="id_phone_number" class="form-label">Номер телефона*:</label>
                            <input type="text" class="form-control" id="id_phone_number" 
                                name="phone_number"
                                value="{{ form.phone_number.value|default_if_none:'' }}"
                                placeholder="(000)000-0000" required>
                            {% if form.phone_number.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.phone_number.errors }}</div>
                            {% endif %}
                            <div class="alert alert-danger alert-dismissible fade show" style="display: none" id="phone_number_error">
                                Неверный формат номера. Используйте формат: (000)000-0000
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">Email*</label>
                            <input type="email" class="form-control" id="id_email"
                                name="email"
                                value="{{ form.email.value|default_if_none:'' }}"
                                placeholder="Введите ваш email" required>
                            {% if form.email.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Пароль -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password1" class="form-label">Пароль*</label>
                            <input type="password" class="form-control" id="id_password1"
                                name="password1"
                                placeholder="Введите пароль" required>
                            {% if form.password1.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.password1.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Подтверждение пароля -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password2" class="form-label">Подтверждение пароля*</label>
                            <input type="password" class="form-control" id="id_password2"
                                name="password2"
                                placeholder="Подтвердите пароль" required>
                            {% if form.password2.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.password2.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-dark btn-block">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Форматирование ввода номера телефона
        $('#id_phone_number').on('input', function(e) {
            var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ')' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        // Валидация формы перед отправкой
        $('#registration_form').on('submit', function(event) {
            // Проверка номера телефона
            var phoneNumber = $('#id_phone_number').val();
            var regex = /^\(\d{3}\)\d{3}-\d{4}$/;
            
            if (!regex.test(phoneNumber)) {
                $('#phone_number_error').show();
                event.preventDefault();
                return false;
            } else {
                $('#phone_number_error').hide();
                
                // Очистка номера телефона перед отправкой
                var cleanedPhoneNumber = phoneNumber.replace(/[()\-]/g, '');
                $('#id_phone_number').val(cleanedPhoneNumber);
            }
            
            // Дополнительные проверки могут быть добавлены здесь
            
            return true;
        });
    });
</script>
{% endblock %}